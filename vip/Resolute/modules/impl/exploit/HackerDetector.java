package vip.Resolute.modules.impl.exploit;

import vip.Resolute.Resolute;
import vip.Resolute.events.Event;
import vip.Resolute.events.impl.EventMotion;
import vip.Resolute.modules.Module;
import vip.Resolute.settings.impl.BooleanSetting;
import vip.Resolute.ui.notification.Notification;
import vip.Resolute.ui.notification.NotificationType;
import vip.Resolute.util.misc.TimerUtil;
import com.mojang.realmsclient.util.Pair;
import java.util.ArrayList;
import java.util.List;
import net.minecraft.block.Block;
import net.minecraft.block.BlockAir;
import net.minecraft.block.BlockLiquid;
import net.minecraft.client.Minecraft;
import net.minecraft.client.entity.EntityOtherPlayerMP;
import net.minecraft.client.entity.EntityPlayerSP;
import net.minecraft.client.network.NetworkPlayerInfo;
import net.minecraft.entity.Entity;
import net.minecraft.entity.EntityLivingBase;
import net.minecraft.entity.player.EntityPlayer;
import net.minecraft.potion.Potion;
import net.minecraft.util.BlockPos;
import net.minecraft.util.MathHelper;
import net.minecraft.util.Vec3;

public class HackerDetector extends Module {
    public BooleanSetting pingSpoof = new BooleanSetting("Ping Spoof", true);
    public BooleanSetting criticals = new BooleanSetting("Criticals", true);
    public BooleanSetting invalidPitch = new BooleanSetting("Invalid Pitch", true);
    public BooleanSetting noSlow = new BooleanSetting("NoSlow", true);
    public BooleanSetting highjump = new BooleanSetting("HighJump", true);
    public BooleanSetting omnisprint = new BooleanSetting("OmniSprint", true);
    public BooleanSetting longjump = new BooleanSetting("LongJump", true);
    public BooleanSetting speed = new BooleanSetting("Speed", true);
    public BooleanSetting step = new BooleanSetting("Step", true);
    public BooleanSetting velocity = new BooleanSetting("Velocity", true);
    public BooleanSetting killaura = new BooleanSetting("Killaura", true);
    public BooleanSetting fly = new BooleanSetting("Fly", true);


    private final List<Pair<EntityPlayer, String>> data = new ArrayList<Pair<EntityPlayer, String>>();
    public static final ArrayList<EntityPlayer> hackers = new ArrayList();
    private final ArrayList<String> hacker = new ArrayList();
    TimerUtil time = new TimerUtil();
    double motionvlY;
    double speedvl;
    double NoKBvl;
    double auravl;
    double noslowvl;

    public static boolean enabled = false;

    @Override
    public void onEnable() {
        super.onEnable();
        hackers.clear();
        this.data.clear();
        this.hacker.clear();
        enabled = true;
    }

    @Override
    public void onDisable() {
        super.onDisable();
        hackers.clear();
        enabled = false;
    }

    public HackerDetector() {
        super("HackerDetector", 0, "Detects Hackers", Category.EXPLOIT);
        this.addSettings(pingSpoof, criticals, invalidPitch,
                noSlow, highjump, omnisprint, longjump, speed,
                step, velocity, killaura, fly);
    }

    public void onEvent(Event e) {
        if(e instanceof EventMotion) {
            EntityPlayer player;
            if (mc.thePlayer.ticksExisted <= 105) {
                hackers.clear();
                return;
            }
            if (mc.theWorld == null) {
                return;
            }
            for (Entity entity : mc.theWorld.getLoadedEntityList()) {
                if (!(entity instanceof EntityPlayer)) continue;
                if (entity instanceof EntityOtherPlayerMP) {
                    player = (EntityOtherPlayerMP)entity;
                    if (this.getSpeed(player) > this.getBaseMoveSpeed() + 0.85 && !((EntityOtherPlayerMP)player).onGround && !this.isInLiquid(player)) {
                        this.informPlayer(player, "Motion/Moving too fast");
                    }
                    if (this.time.hasElapsed(1003L)) {
                        this.time.reset();
                    }
                    if (!((EntityOtherPlayerMP)player).isBlocking()) {
                        this.time.reset();
                    }
                    if (((EntityOtherPlayerMP)player).isBlocking() && (double)((EntityOtherPlayerMP)player).moveForward >= 0.9 && this.time.hasElapsed(200L)) {
                        this.informPlayer(player, "No Slow Down");
                    }
                    if (this.fly.isEnabled() && ((EntityOtherPlayerMP)player).motionY == 0.0 && this.getSpeed(player) > 0.2775 && mc.thePlayer.ticksExisted % 2 == 0 && ((EntityOtherPlayerMP)player).posY - ((EntityOtherPlayerMP)player).lastTickPosY > 0.02 && !this.isInLiquid(player)) {
                        this.informPlayer(player, "Flight");
                    }
                }
                if ((player = (EntityPlayer)entity) instanceof EntityPlayerSP || !player.isEntityAlive() || mc.playerController.isSpectator() || player.isSpectator()) continue;
                if (this.criticals.isEnabled() && player.fallDistance > 0.0f && !this.checkGround(player.posY) && player.ridingEntity == null && (player.posY % 1.0 == 0.0 || player.posY % 0.5 == 0.0) && (double)player.fallDistance < 0.06251 && !player.isPotionActive(Potion.blindness)) {
                    this.informPlayer(player, "Criticals(Invalid Pos)");
                    hackers.add(player);
                }
                if (this.pingSpoof.isEnabled()) {
                    try {
                        NetworkPlayerInfo info = mc.getNetHandler().getPlayerInfo(player.getName());
                        if (info != null && info.getResponseTime() > 600) {
                            this.informPlayer(player, String.format("PingSpoof(%dms)", info.getResponseTime()));
                            hackers.add(player);
                        }
                    }
                    catch (Throwable info) {
                        info.printStackTrace();
                    }
                }
                if (!this.invalidPitch.isEnabled() || !(player.rotationPitch > 90.0f) && !(player.rotationPitch < -90.0f)) continue;
                this.informPlayer(player, "Invalid Pitch");
                hackers.add(player);
            }
            for (Entity entity : mc.theWorld.playerEntities) {
                double lastY;
                double y;
                double yDiff;
                player = (EntityPlayer)entity;
                if (player instanceof EntityPlayerSP || player == mc.thePlayer || player.ticksExisted < 105 || hackers.contains(player) || player.capabilities.isFlying || player.capabilities.isCreativeMode) continue;
                double playerSpeed = getBPS(player);
                if (this.killaura.isEnabled() && player.swingProgress < 2.0f && player.swingProgress != 0.0f) {
                    float[] rots = getFacePosEntityRemote(mc.thePlayer, player);
                    boolean highYawRate = false;
                    if (Math.abs(player.rotationYaw - player.prevRotationYaw) > 40.0f) {
                        highYawRate = true;
                    }
                    if (Math.abs(player.rotationYaw - rots[0]) < 2.0f) {
                        if (highYawRate) {
                            this.auravl += 1.0;
                            if (this.auravl >= 30.0) {
                                Resolute.getNotificationManager().add(new Notification("Hacker Detected!", "§f" + player.getName() + "§f is using Kill Aura", 5000, NotificationType.WARNING));
                                this.auravl = 0.0;
                                hackers.add(player);
                            }
                        }
                        this.auravl += 1.0;
                        if (this.auravl >= 30.0) {
                            Resolute.getNotificationManager().add(new Notification("Hacker Detected!", "§f" + player.getName() + "§f is using Kill Aura", 5000, NotificationType.WARNING));
                            this.auravl = 0.0;
                            hackers.add(player);
                        }
                    }
                }
                if (this.noSlow.isEnabled() && player.isBlocking() && SpeedBs(player) >= 6.0) {
                    this.noslowvl += 1.0;
                    if (this.noslowvl >= 30.0) {
                        Resolute.getNotificationManager().add(new Notification("Hacker Detected!", "§f" + player.getName() + "§f is using No Slow", 5000, NotificationType.WARNING));
                        this.noslowvl = 0.0;
                        hackers.add(player);
                    }
                }
                if (this.highjump.isEnabled() && player.motionY > 1.0) {
                    this.motionvlY += 1.0;
                    if (this.motionvlY >= 25.0) {
                        Resolute.getNotificationManager().add(new Notification("Hacker Detected!", "§f" + player.getName() + "§f is using High Jump", 5000, NotificationType.WARNING));
                        this.motionvlY = 0.0;
                        hackers.add(player);
                    }
                }
                if (this.omnisprint.isEnabled() && player.isSprinting() && (player.moveForward < 0.0f || player.moveForward == 0.0f && player.moveStrafing != 0.0f)) {
                    Resolute.getNotificationManager().add(new Notification("Hacker Detected!", "§f" + player.getName() + "§f is using Omni Sprint", 5000, NotificationType.WARNING));
                    hackers.add(player);
                }
                if (this.longjump.isEnabled() && !mc.theWorld.getCollidingBoundingBoxes(player, mc.thePlayer.getEntityBoundingBox().offset(0.0, player.motionY, 0.0)).isEmpty() && player.motionY > 0.0 && playerSpeed > 10.0) {
                    Resolute.getNotificationManager().add(new Notification("Hacker Detected!", "§f" + player.getName() + "§f is using Long Jump", 5000, NotificationType.WARNING));
                    hackers.add(player);
                }
                double xDif = player.posX - player.prevPosX;
                double zDif = player.posZ - player.prevPosZ;
                double lastDist = Math.sqrt(xDif * xDif + zDif * zDif) * 20.0;
                if (this.speed.isEnabled() && Math.round(lastDist) > 15L) {
                    this.speedvl += 1.0;
                    if (this.speedvl >= 150.0) {
                        Resolute.getNotificationManager().add(new Notification("Hacker Detected!", "§f" + player.getName() + "§f is using Speed", 5000, NotificationType.WARNING));
                        this.speedvl = 0.0;
                        hackers.add(player);
                    }
                }
                double d = yDiff = (y = (double)Math.abs((int)player.posY)) > (lastY = (double)Math.abs((int)player.lastTickPosY)) ? y - lastY : lastY - y;
                if (this.step.isEnabled() && yDiff > 0.0 && mc.thePlayer.onGround && player.motionY == -0.0784000015258789) {
                    Resolute.getNotificationManager().add(new Notification("Hacker Detected!", "§f" + player.getName() + "§f is using Step", 5000, NotificationType.WARNING));
                    this.speedvl = 0.0;
                    hackers.add(player);
                }
                if (!this.velocity.isEnabled()) continue;
                if (player.hurtResistantTime > 6 && player.hurtResistantTime < 12 && player.lastTickPosX == player.posX && player.posZ == player.lastTickPosZ && !mc.theWorld.checkBlockCollision(player.getEntityBoundingBox().expand(0.05, 0.0, 0.05))) {
                    this.NoKBvl += 1.0;
                    if (this.NoKBvl >= 50.0) {
                        Resolute.getNotificationManager().add(new Notification("Hacker Detected!", "§f" + player.getName() + "§f is using Velocity", 5000, NotificationType.WARNING));
                        this.NoKBvl = 0.0;
                        hackers.add(player);
                    }
                }
                if (player.hurtResistantTime <= 6 || player.hurtResistantTime >= 12 || player.lastTickPosY != player.posY) continue;
                this.NoKBvl += 1.0;
                if (!(this.NoKBvl >= 40.0)) continue;
                Resolute.getNotificationManager().add(new Notification("Hacker Detected!", "§f" + player.getName() + "§f is using Velocity", 5000, NotificationType.WARNING));
                this.NoKBvl = 0.0;
                hackers.add(player);
            }
        }
    }

    public static boolean isHacker(EntityLivingBase ent) {
        for (EntityPlayer hacker : hackers) {
            if (!ent.getName().equals(hacker.getName())) continue;
            return true;
        }
        return false;
    }

    private boolean checkGround(double y) {
        return y % 0.015625 == 0.0;
    }

    private void informPlayer(EntityPlayer player, String hakk) {
        for (Pair<EntityPlayer, String> pair : this.data) {
            if (pair.first() != player || !((String)pair.second()).equalsIgnoreCase(hakk)) continue;
            return;
        }

        Resolute.getNotificationManager().add(new Notification("Hacker Detected!", String.format("§f%s is using %s", player.getName(), hakk, Float.valueOf(player.getHealth()), Float.valueOf(player.getMaxHealth())), 5000, NotificationType.WARNING));
        this.data.add(Pair.of(player, hakk));
    }

    private double getSpeed(EntityPlayer player) {
        return Math.sqrt(player.motionX * player.motionX + player.motionZ * player.motionZ);
    }

    private double getBaseMoveSpeed() {
        double baseSpeed = 0.2875;
        if (mc.thePlayer.isPotionActive(Potion.moveSpeed)) {
            baseSpeed *= 1.0 + 0.2 * (double)(mc.thePlayer.getActivePotionEffect(Potion.moveSpeed).getAmplifier() + 1);
        }
        return baseSpeed;
    }

    private boolean isInLiquid(Entity e) {
        for (int x = MathHelper.floor_double(e.getEntityBoundingBox().minY); x < MathHelper.floor_double(e.getEntityBoundingBox().maxX) + 1; ++x) {
            for (int z = MathHelper.floor_double(e.getEntityBoundingBox().minZ); z < MathHelper.floor_double(e.getEntityBoundingBox().maxZ) + 1; ++z) {
                BlockPos pos = new BlockPos(x, (int)e.getEntityBoundingBox().minY, z);
                Block block = Minecraft.getMinecraft().theWorld.getBlockState(pos).getBlock();
                if (block == null || block instanceof BlockAir) continue;
                return block instanceof BlockLiquid;
            }
        }
        return false;
    }

    private static float[] getFacePosRemote(Vec3 src, Vec3 dest) {
        double diffX = dest.xCoord - src.xCoord;
        double diffY = dest.yCoord - src.yCoord;
        double diffZ = dest.zCoord - src.zCoord;
        double dist = MathHelper.sqrt_double(diffX * diffX + diffZ * diffZ);
        float yaw = (float)(Math.atan2(diffZ, diffX) * 180.0 / Math.PI) - 90.0f;
        float pitch = (float)(-Math.atan2(diffY, dist) * 180.0 / Math.PI);
        return new float[]{MathHelper.wrapAngleTo180_float(yaw), MathHelper.wrapAngleTo180_float(pitch)};
    }

    public static double getBPS(Entity entityIn) {
        double xDist = entityIn.posX - entityIn.prevPosX;
        double zDist = entityIn.posZ - entityIn.prevPosZ;
        double bps = Math.sqrt(xDist * xDist + zDist * zDist) * 20.0;
        return (double)((int)bps) + bps - (double)((int)bps);
    }

    public static double SpeedBs(Entity entity) {
        double xDif = entity.posX - entity.prevPosX;
        double zDif = entity.posZ - entity.prevPosZ;
        double lastDist = Math.sqrt(xDif * xDif + zDif * zDif) * 20.0;
        return Math.round(lastDist);
    }

    public static float[] getFacePosEntityRemote(EntityLivingBase facing, Entity en) {
        if (en == null) {
            return new float[]{facing.rotationYawHead, facing.rotationPitch};
        }
        return getFacePosRemote(new Vec3(facing.posX, facing.posY + (double)en.getEyeHeight(), facing.posZ), new Vec3(en.posX, en.posY + (double)en.getEyeHeight(), en.posZ));
    }
}
