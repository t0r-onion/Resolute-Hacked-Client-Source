package vip.Resolute.modules.impl.exploit;

import vip.Resolute.Resolute;
import vip.Resolute.events.Event;
import vip.Resolute.events.impl.EventMotion;
import vip.Resolute.ui.notification.Notification;
import vip.Resolute.ui.notification.NotificationType;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import disabler.mc.auth.exception.request.RequestException;
import disabler.mc.protocol.MinecraftConstants;
import disabler.mc.protocol.MinecraftProtocol;
import disabler.mc.protocol.data.game.PlayerListEntry;
import disabler.mc.protocol.data.game.PlayerListEntryAction;
import disabler.mc.protocol.data.message.Message;
import disabler.mc.protocol.packet.ingame.client.ClientChatPacket;
import disabler.mc.protocol.packet.ingame.client.player.ClientPlayerPositionRotationPacket;
import disabler.mc.protocol.packet.ingame.server.*;
import disabler.mc.protocol.packet.ingame.server.entity.ServerEntityPositionPacket;
import disabler.mc.protocol.packet.ingame.server.entity.player.ServerPlayerPositionRotationPacket;
import disabler.mc.protocol.packet.ingame.server.entity.spawn.ServerSpawnPlayerPacket;
import disabler.packetlib.Client;
import disabler.packetlib.event.session.DisconnectedEvent;
import disabler.packetlib.event.session.PacketReceivedEvent;
import disabler.packetlib.event.session.SessionAdapter;
import disabler.packetlib.tcp.TcpSessionFactory;
import net.minecraft.client.Minecraft;
import net.minecraft.network.play.client.C01PacketChatMessage;
import org.apache.commons.lang3.tuple.MutablePair;

import javax.vecmath.Vector3d;
import java.net.Proxy;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;
import vip.Resolute.modules.Module;

public class MineplexDisabler extends Module {
    private final int PORT = 25565;
    private final JsonParser PARSER = new JsonParser();
    public final Map<UUID, MutablePair<Integer, String>> entityCache = new HashMap<UUID, MutablePair<Integer, String>>();
    public Vector3d clientPos = new Vector3d(0, Double.MIN_VALUE, 0);
    private int playerId;
    public String spectatorIGN;
    public Client client;
    private long loginTime;
    public MineplexStatus currentStatus = MineplexStatus.DISCONNECTED;

    public MineplexDisabler() {
        super("MineplexDisabler", 0, "Disables Mineplex", Category.EXPLOIT);
    }

    private Client login() {
        currentStatus = MineplexStatus.CONNECTING;
        loginTime = System.currentTimeMillis();
        String[] userInfo = Resolute.instance.getSpectatorAlt();

        MinecraftProtocol protocol;
        try {
            protocol = new MinecraftProtocol(userInfo[0], userInfo[1], false);
        } catch (RequestException e) {
            Resolute.getNotificationManager().add(new Notification("Error", "Failed to log into alt", 5000L, NotificationType.ERROR));
            e.printStackTrace();
            return null;
        }
        spectatorIGN = protocol.getProfile().getName();
        Client client = new Client("us.mineplex.com", PORT, protocol, new TcpSessionFactory());
        client.getSession().setFlag(MinecraftConstants.AUTH_PROXY_KEY, Proxy.NO_PROXY);
        client.getSession().addListener(new SessionAdapter() {

            @Override
            public void packetReceived(PacketReceivedEvent event) {
                if (Minecraft.getMinecraft().thePlayer == null) {
                    client.getSession().disconnect("Disconnected");
                }
                if (event.getPacket() instanceof ServerChatPacket) {
                    Message message = event.<ServerChatPacket>getPacket().getMessage();
                    JsonElement element = message.toJson();
                    try {
                        if (message.getFullText().toLowerCase().contains("join> " + spectatorIGN.toLowerCase())) {
                            Resolute.addChatMessage("[BOT] " + message.getFullText());
                            client.getSession().send(new ClientChatPacket("/spec"));
                            Resolute.addChatMessage("Sent /spec");
                        }
                        if (element instanceof JsonObject) {
                            client.getSession().send(new ClientChatPacket(PARSER.parse(element.getAsJsonObject().getAsJsonObject().get("text").getAsString()).getAsJsonObject()
                                    .get("extra").getAsJsonArray().get(0).getAsJsonObject()
                                    .get("extra").getAsJsonArray().get(1).getAsJsonObject().get("clickEvent").getAsJsonObject().get("value").getAsString()));
                            System.out.println("Got party invite.");
                        }
                    } catch (Exception ignored) {
                    }
                }
                if (event.getPacket() instanceof ServerDisconnectPacket) {
                    Resolute.addChatMessage("[\u00a7cMPD\u00a7c] " + "Alt was disconnected: " + ((ServerDisconnectPacket) event.getPacket()).getReason().getFullText());
                }
                if (event.getPacket() instanceof ServerPlayerPositionRotationPacket) {
                    ServerPlayerPositionRotationPacket positionRotationPacket = event.getPacket();
                    clientPos = new Vector3d(positionRotationPacket.getX(), positionRotationPacket.getY(), positionRotationPacket.getZ());
                    for (int i = 0; i < 2; i++)
                        client.getSession().send(new ClientPlayerPositionRotationPacket(true, positionRotationPacket.getX(), positionRotationPacket.getY(), positionRotationPacket.getZ(), 0, 0));
                }

                if (event.getPacket() instanceof ServerEntityPositionPacket) {
                    ServerEntityPositionPacket packet = event.getPacket();
                    if (packet.getEntityId() == playerId) {
                        clientPos = new Vector3d(packet.getMovementX(), packet.getMovementY(), packet.getMovementZ());
                    }
                }
                if (event.getPacket() instanceof ServerJoinGamePacket) {
                    currentStatus = MineplexStatus.CONNECTED;
                    ServerJoinGamePacket joinGamePacket = event.getPacket();
                    playerId = joinGamePacket.getEntityId();
                    new Thread(() -> Minecraft.getMinecraft().getNetHandler().sendPacketNoEvent(new C01PacketChatMessage("/party " + spectatorIGN))).start();
                }
                if (event.getPacket() instanceof ServerRespawnPacket) {
                    //TODO handle respawn
                    @SuppressWarnings("unused") ServerRespawnPacket packet = event.getPacket();
                }
                if (event.getPacket() instanceof ServerSpawnPlayerPacket) {
                    ServerSpawnPlayerPacket packet = event.getPacket();
                    if (packet.getEntityId() == playerId) {
                        clientPos = new Vector3d(packet.getX(), packet.getY(), packet.getZ());
                    }
                    entityCache.put(packet.getUUID(), new MutablePair<>(packet.getEntityId(), ""));
                }
                if (event.getPacket() instanceof ServerPlayerListEntryPacket) {
                    ServerPlayerListEntryPacket packet = event.getPacket();
                    if (packet.getAction() == PlayerListEntryAction.ADD_PLAYER) {
                        for (PlayerListEntry entry : packet.getEntries()) {
                            for (UUID set : entityCache.keySet()) {
                                if (set.equals(entry.getProfile().getId())) {
                                    entityCache.get(set).right = entry.getProfile().getName();
                                }
                            }
                        }
                    }
                }
            }

            @Override
            public void disconnected(DisconnectedEvent event) {
                currentStatus = MineplexStatus.DISCONNECTED;
                System.out.println("Bot Disconnected: " + Message.fromString(event.getReason()).getFullText());
                entityCache.clear();
                if (event.getCause() != null) {
                    event.getCause().printStackTrace();
                }
            }
        });
        return client;
    }

    public enum MineplexStatus {
        DISCONNECTED("\u00a7cDisconnected"), CONNECTING("\u00a7eConnecting..."), CONNECTED("\u00a7aConnected");

        private final String display;

        MineplexStatus(String display) {
            this.display = display;
        }

        @Override
        public String toString() {
            return display;
        }
    }

    public void onEvent(Event e) {
        if(e instanceof EventMotion) {
            long timeDiff = System.currentTimeMillis() - loginTime;

            if(Resolute.instance.getSpectatorAlt() != null && currentStatus != MineplexStatus.CONNECTED && timeDiff > 5000) {
                client.getSession().disconnect("Disconnected");
                update();
            }
        }
    }

    public void update() {
        entityCache.clear();
        client = login();
        assert client != null;
        client.getSession().connect();
    }
}
