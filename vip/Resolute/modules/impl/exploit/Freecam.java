package vip.Resolute.modules.impl.exploit;

import vip.Resolute.events.Event;
import vip.Resolute.events.impl.EventPacket;
import vip.Resolute.events.impl.EventUpdate;
import vip.Resolute.modules.Module;
import vip.Resolute.settings.impl.NumberSetting;
import vip.Resolute.util.movement.MovementUtils;
import net.minecraft.client.entity.EntityOtherPlayerMP;
import net.minecraft.client.entity.EntityPlayerSP;
import net.minecraft.network.Packet;
import net.minecraft.network.play.client.C03PacketPlayer;
import net.minecraft.network.play.client.C0BPacketEntityAction;
import net.minecraft.network.play.server.S07PacketRespawn;
import net.minecraft.network.play.server.S08PacketPlayerPosLook;
import net.minecraft.network.play.server.S12PacketEntityVelocity;

public class Freecam extends Module {
    public NumberSetting speed = new NumberSetting("Speed", 2.0, 0.1, 10.0, 0.1);
    public double oldX;
    public double oldY;
    public double oldZ;
    public float oldYaw;
    public float oldPitch;
    public EntityOtherPlayerMP player;

    public Freecam() {
        super("Freecam", 0, "Allows the player to freely look around", Category.EXPLOIT);
        this.addSettings(speed);
    }

    public void onEnable() {
        this.oldX = this.mc.thePlayer.posX;
        this.oldY = this.mc.thePlayer.posY;
        this.oldZ = this.mc.thePlayer.posZ;
        this.oldYaw = this.mc.thePlayer.rotationYaw;
        this.oldPitch = this.mc.thePlayer.rotationPitch;
        (this.player = new EntityOtherPlayerMP(this.mc.theWorld, this.mc.thePlayer.getGameProfile())).copyLocationAndAnglesFrom(this.mc.thePlayer);
        this.player.rotationYawHead = this.mc.thePlayer.rotationYawHead;
        this.player.renderYawOffset = this.mc.thePlayer.renderYawOffset;
        this.mc.theWorld.addEntityToWorld(-6969, this.player);
        this.mc.thePlayer.noClip = true;
    }

    public void onDisable() {
        this.mc.thePlayer.setPosition(this.oldX, this.oldY, this.oldZ);
        this.mc.thePlayer.rotationYaw = this.oldYaw;
        this.mc.thePlayer.rotationPitch = this.oldPitch;
        this.mc.thePlayer.motionX = 0.0;
        this.mc.thePlayer.motionY = 0.0;
        this.mc.thePlayer.motionZ = 0.0;
        this.mc.theWorld.removeEntity(this.player);
        this.player = null;
    }

    public void onEvent(Event e) {
        if(e instanceof EventUpdate) {
            this.mc.thePlayer.noClip = true;
            this.mc.thePlayer.fallDistance = 0.0f;
            this.mc.thePlayer.motionX = 0.0;
            this.mc.thePlayer.motionY = 0.0;
            this.mc.thePlayer.motionZ = 0.0;
            MovementUtils.strafe((float) speed.getValue());
            if (this.mc.gameSettings.keyBindJump.isKeyDown()) {
                final EntityPlayerSP thePlayer = this.mc.thePlayer;
                thePlayer.motionY += 0.5;
            }
            if (this.mc.gameSettings.keyBindSneak.isKeyDown()) {
                final EntityPlayerSP thePlayer2 = this.mc.thePlayer;
                thePlayer2.motionY -= 0.5;
            }
        }

        if(e instanceof EventPacket) {
            EventPacket eventPacket = (EventPacket) e;
            Packet<?> packet = eventPacket.getPacket();
            if((packet instanceof C03PacketPlayer) || (packet instanceof C0BPacketEntityAction)) {
                eventPacket.setCancelled(true);
            }

            if(packet instanceof S08PacketPlayerPosLook) {
                this.oldX = ((S08PacketPlayerPosLook) packet).getX();
                this.oldY = ((S08PacketPlayerPosLook) packet).getY();
                this.oldZ = ((S08PacketPlayerPosLook) packet).getY();
                this.oldYaw = ((S08PacketPlayerPosLook) packet).getYaw();
                this.oldPitch = ((S08PacketPlayerPosLook) packet).getPitch();
                this.player.posX = this.oldX;
                this.player.posY = this.oldY;
                this.player.posZ = this.oldZ;
                this.player.rotationYaw = this.oldYaw;
                this.player.rotationPitch = this.oldPitch;
                eventPacket.setCancelled(true);
                mc.getNetHandler().addToSendQueue(new C03PacketPlayer.C06PacketPlayerPosLook(this.oldX, this.oldY, this.oldZ, this.oldYaw, this.oldPitch, false));
            }

            if(packet instanceof S07PacketRespawn) {
                toggled = false;
            }

            if(packet instanceof S12PacketEntityVelocity) {
                EntityOtherPlayerMP playerMP = player;
                playerMP.motionY += 4.0;
            }
        }
    }
}
